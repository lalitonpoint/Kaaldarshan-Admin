
<style>
#chatContainer {
  max-height: 400px;
  overflow-y: auto;
  padding: 15px;
  background-color: #f8f9fa;
}

.chat-message {
  display: flex;
  margin-bottom: 12px;
}

.chat-message.user {
  justify-content: flex-start;
}

.chat-message.admin {
  justify-content: flex-end;
}

.chat-bubble {
  max-width: 60%;
  padding: 10px 15px;
  border-radius: 15px;
  position: relative;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  background-color: #e2f0d9;
}

.chat-message.admin .chat-bubble {
  background-color: #cfe2ff;
}

.chat-bubble p {
  margin: 0 0 5px;
}

.timestamp {
  font-size: 0.75rem;
  color: #6c757d;
  display: block;
  text-align: right;
}
</style>

<div class="">
    <div class="bg-white">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <ul class="nav nav-tabs mobile_app_nav" id="myTab" role="tablist">
                        <li class="nav-item " role="presentation">
                            <a class="nav-link active" id="mobile-menu-list-tab" data-bs-toggle="tab" data-bs-target="#mobile-menu-list" type="button" role="tab" href="#mobile-menu-list" aria-controls="mobile-menu-list" aria-selected="true">Ticket
                             Management</a>
                        </li>

                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="tab-content mabile_app_content mobile_banner_content my-3 " id="myTabContent">
                    <div class="tab-pane fade " id="mobile-menu" role="tabpanel" aria-labelledby="mobile-menu-tab">
                        <form class="mobile_menu_form mobile_dash_dt" method="post" id="mobile_menu_content_form" enctype="multipart/form-data" autocomplete="off">
                           <!--  <input type="hidden" id="token" name="<?= $this->security->get_csrf_token_name(); ?>" value="<?php echo $token; ?>" /> -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fname" class="label_mb_dt mb-1">User id<span class="m_star">*</span><span class="max_mobile_content">(Maximum 50 Characters allowed)</span></label>
                                    <input type="text" class="form-control" name='UserName' id="UserName" placeholder="Enter User Name" maxlength="50" > <!-- onkeyup="this.value=this.value.replace(/[^a-zA-Z0-9-_/()!{}. ]/g,'')" -->
                                    <span class="text-danger" id="span_CategoryName"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="image_dt" class="label_mb_dt mb-1">User Query<span class="m_star">*</span></label>
                                    <input type="text" class="form-control" name='UserMobile' id="UserMobile" placeholder="Enter User Mobile" maxlength="50" > <!-- onkeyup="this.value=this.value.replace(/[^a-zA-Z0-9-_/()!{}. ]/g,'')" -->
                                    <span class="text-danger" id="span_UserMobile"></span>
                                </div>
                                
                        <div class="form-group">
                                    <label for="statusDropdown">Query Status</label>
                                    <select id="statusDropdown" class="form-control">
                                        <option value="1">Open</option>
                                        <option value="2">Closed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="statusDropdown">Status</label>
                                    <select id="statusDropdown" class="form-control">
                                        <option value="1">Active</option>
                                        <option value="2">Inactive</option>
                                    </select>
                                </div>
                                
                                
                                
                                <div class="col-md-12">
                                    <button type="submit" class="dash_btn submit_btns">Submit</button>
                                </div>
                            </div>
                        </form>

                    </div>
                    <div class="tab-pane fade show active" id="mobile-menu-list" role="tabpanel" aria-labelledby="mobile-menu-list-tab">
                        
                        <div class="col-sm-12">
                            <section class="panel">
                            
                                <div class="panel-body">
                                    <div class="adv-table ">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-striped bg-white mt-2" id="all-user-grid" style="width:99% !important; ">
                                            <thead>
                                                <tr>
                                                     <th style="max-width:40px;">S.No.</th>
                                                    <th>User Id </th>
                                                    <th>User Query</th>
                                                    
                                                    <!-- <th>Category Banner</th> -->
                                                    <!-- <th>Action By</th> -->
                                                    <th>Query Status </th>
                                                    <th>Status </th>
                                                    <th>Action </th>
                                                </tr>
                                       
                                                <tr class="dnr" >
                                                    <th  style="max-width:40px;"><input type="text" data-column="1" class="search-input-text form-control"></th>
                                                    <th></th>
                                                    <th></th>
                                                    <th></th>
                                                    <th></th>
                                                    <th></th>
                                                    <!-- <th></th> -->
                                                </tr>
                                            </thead>
                                        </table>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                    </div>


                    <div class="tab-pane fade" id="mobile-order-mgmt" role="tabpanel" aria-labelledby="mobile-order-mgmt-tab">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="d-flex align-items-center justify-content-between">
                                  
                                </div>
                            </div>
                        </div>
                        <div class="mobile_menu_order_data" > </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title"> Chat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="chatContainer" class="chat-container"></div>

        <form id="chatForm" class="message-form">
          <input type="hidden" id="ticketId" />
          <input type="text" id="chatInput" placeholder="Type a message..." required />
          <button type="submit">Send</button>
        </form>
      </div>

    </div>
  </div>
</div>

<script>
function openChatModal(ticketId) {
  document.getElementById("ticketId").value = ticketId;
  fetchChatMessages(ticketId);
  const modal = new bootstrap.Modal(document.getElementById("chatModal"));
  modal.show();
}

function fetchChatMessages(ticketId) {
  fetch(`/ticket/edit_ticket/${ticketId}`)
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById("chatContainer");
      container.innerHTML = ''; // Clear previous messages

      data.forEach(msg => {
        const msgDiv = document.createElement('div');
        const isUser = msg.sender === 'user';

        msgDiv.className = `chat-message ${isUser ? 'user' : 'admin'}`;
        msgDiv.innerHTML = `
          <div class="chat-bubble">
            <p>${msg.user_query || msg.admin_reply}</p>
            <span class="timestamp">${new Date(msg.created_at).toLocaleString()}</span>
          </div>
        `;
        container.appendChild(msgDiv);
      });

      container.scrollTop = container.scrollHeight;
    })
    .catch(error => {
      console.error('Error fetching chat messages:', error);
    });
}

document.getElementById("chatForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const ticketId = document.getElementById("ticketId").value;
  const message = document.getElementById("chatInput").value;

  if (!message.trim()) return;

  // ‚è± 1. Show admin message immediately in UI
  const container = document.getElementById("chatContainer");
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chat-message admin';
  msgDiv.innerHTML = `
    <div class="chat-bubble">
      <p>${message}</p>
      <span class="timestamp">${new Date().toLocaleString()}</span>
    </div>
  `;
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;

  // üîÑ 2. Submit via API in background
  const formData = new FormData();
  formData.append('admin_reply', message);
  formData.append('sender', 'admin');

  fetch(`/ticket/updateTicket/${ticketId}`, {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(() => {
    document.getElementById("chatInput").value = '';
    // Optionally refetch from server to sync
    // fetchChatMessages(ticketId);
  })
  .catch(err => console.error('Message send error:', err));
});
</script>


<script type="text/javascript">
 jQuery(document).ready(function() {
    var table = 'all-user-grid';
    var dataTable = jQuery("#" + table).DataTable({
        "dom": '<l>Bfrtip',
        "processing": true, // Show processing indicator
        "pageLength": 10,
        "paging": true,
        "lengthMenu": [
            [10, 20, 50, 100, 500],
            [10, 20, 50, 100, 500]
        ],
        "serverSide": true,
        "ordering": false,
        "buttons": [
            {
                extend: 'csvHtml5',
                exportOptions: {
                    columns: [0, 2, 3, 4],
                    rows: ":not('.dnr')" // Exclude rows with class 'dnr'
                }
            }
        ],
        "columnDefs": [{
            "targets": [0, 2, 3, 4],
            "orderable": false // Disable ordering for specified columns
        }],
        "order": [
            [1, "asc"] // Default order by second column
        ],
        "ajax": {
            url: "ticket/get_all_ticket_ajax/", // JSON datasource
            type: "POST", // Use POST method
            data: function (d) {
                // Add additional parameters if needed
                // d.customParam = 'value'; // Example: additional parameters
            },
            error: function(xhr, error, thrown) { // Improved error handling
                console.error("Error loading data: ", error);
                jQuery("." + table + "-error").html("Error loading data.");
                jQuery("#" + table + "_processing").css("display", "none");
            },
        },
        "language": {
            "paginate": {
                "next": "Next",
                "previous": "Previous"
            },
            "emptyTable": "No data available in table", // Custom message for empty table
            "zeroRecords": "No matching records found" // Custom message for no matching records
        }
    });

    // Hide the default filter input
    jQuery("#" + table + "_filter").css("display", "none");

    // For text input search
    $('.search-input-text').on('keyup click', function() {
        var i = $(this).data('column'); // getting column index using jQuery's .data() method
        var v = $(this).val(); // getting search input value
        dataTable.columns(i).search(v).draw(); // Search and redraw the table
    });

    // For select box search
    $('.search-input-select').on('change', function() {
        var i = $(this).data('column'); // getting column index using jQuery's .data() method
        var v = $(this).val(); // getting selected value
        dataTable.columns(i).search(v).draw(); // Search and redraw the table
    });
});


</script>

<script >




$(document).ready(function() {
    $('#UserName').keyup(function() {
        $('.submit_btns').attr('disabled', false);
        $('#span_CategoryName').html('');

        var name = $('#UserName').val();
        var sname = name.replace(/\s+/g, ' ');
        $('#UserName').val(sname);

        if (/[^a-zA-Z0-9-_, ]/.test(sname)) {
            $('#span_CategoryName').html('Special characters are not allowed.');
            $('.submit_btns').attr('disabled', true);
        } else {
            $('#span_CategoryName').html('');
            $('.submit_btns').attr('disabled', false);
        }
    });
});

    $(document).ready(function() {
    $('.submit_btns').on('click', function(e) {
        e.preventDefault(); // Prevent default form submission
        $('.text-danger').html(''); // Clear any previous error messages

        var UserName = $('#UserName').val();
        var UserMobile = $('#UserMobile').val();
        var return_false = 0;

        // Input validation
        if (UserName.trim() === '') {
            $('#span_CategoryName').html('Please enter UserName');
            $('#UserName').focus();
            return_false = 1;
        } else if (UserMobile.trim() === '') {
            $('#span_UserMobile').html('Please enter UserName');
            $('#UserMobile').focus(); // Focus on the thumbnail input
            return_false = 1;
        } 

        // Prevent form submission if validation fails
        if (return_false === 1) {
            return;
        }

        // Create FormData object
        var form = $('#mobile_menu_content_form')[0];
        var formData = new FormData(form); // Ensure form is properly referenced

        const Status = $('#statusDropdown').val();  // Get selected value of status
        formData.append('Status', Status);

        $.ajax({
            url: "/user/add_user_ajax/",
            type: 'POST',
            data: formData,
            dataType: 'json',
            processData: false, // Important for FormData
            contentType: false, // Important for FormData
            success: function(res) {
                console.log('Response from server:', res); // Debugging response
                if (res.status === true) {
                    // Show success message or redirect
                    alert('Category added successfully!');
                    $('#mobile_menu_content_form')[0].reset(); // Reset the form
                } else {
                    // Handle failure case
                    alert(res.message || 'An error occurred while adding the category.');
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                console.error('Error occurred:', xhr.responseText); // Log error response
                alert('An error occurred. Please try again later.');
            }
        });
    });
});




$(function() { // Dropdown toggle
    $('.dropdown-toggle').click(function() {
        $(this).next('.dropdowns').slideToggle();
    });

    $(document).click(function(e) {
        var target = e.target;
        if (!$(target).is('.dropdown-toggle') && !$(target).parents().is('.dropdown-toggle'))
        //{ $('.dropdown').hide(); }
        {
            $('.dropdowns').slideUp();
        }
    });
});



</script>

<script type = "text/javascript" >
    function position_load() {
        $(".row_position").sortable({
            delay: 150,
            axis: 'y',
            stop: function() {
                var selectedData = new Array();
                $('.row_position>div').each(function() {
                    selectedData.push($(this).attr("id"));
                });
                updateMenuOrder(selectedData);
            }
        });
    }
    function updateMenuOrder(data) {
    $.ajax({
        url: "category/category_menu_position", // Adjust the URL if necessary
        type: 'POST', // Ensure the method is POST
        contentType: 'application/json', // Set content type to JSON if sending as JSON
        data: JSON.stringify({ position: data }), // Convert the data to JSON string
        success: function(response) {
            show_toast('success', 'Position has been saved successfully', '');
            $("#mobile-order-mgmt-tab").click(); // Trigger the click event
        },
        error: function(xhr, status, error) {
            console.error('Error details:', error); // Log error details for debugging
            show_toast('danger', 'Something went wrong', '');
        }
    });
}

$(document).on('click', '.delete_menu', function(e) {
    e.preventDefault();
    var id = $(this).attr("id");
    swal({
        title: '$delete_sm',
        text: '$delete_lg',
        // icon: "warning",
        imageUrl: '$AUTH_ASSETS' + 'img/order_confirm.png',
        imageWidth: 70,
        imageHeight: 70,
        allowOutsideClick: false,
        imageAlt: 'Custom image',
        animation: false,
        confirmButtonColor: '#AA4A44',
        cancelButtonColor: '#808080',
        confirmButtonText: "Yes",
        showCancelButton: true,
        confirmButtonText: '$delete_btn_cfm',
        cancelButtonText: '$confirm_cncl',
        // confirmButtonClass: 'btn btn-success me-2',
        // cancelButtonClass: 'btn btn-danger',
    }).then((result) => {
        if (result.value) {


            $.ajax({
                url: "$delete_category",
                type: 'post',
                dataType: 'Json',
                data: {
                    id: id,
                    "{$this->security->get_csrf_token_name()}": "{$this->security->get_csrf_hash()}",
                },
                success: function(data) {
                   if(data.token){
                        $('input[name="{$this->security->get_csrf_token_name()}"]').val(data.token);
                    }
                    swal({
                        title: '$sm_deleted',
                        text: '$lg_deleted',
                        // icon: 'success',
                        imageUrl: '$AUTH_ASSETS' + 'img/order_confirms.png',
                        imageWidth: 70,
                        imageHeight: 70,
                        allowOutsideClick: false,
                        imageAlt: 'Custom image',
                    }).then((result) => {

                        location.reload();


                    });
                }
            })
        }
    })

});


$(document).on('click', '.disable_menu', function(e) {
    e.preventDefault();

    var id = $(this).attr("id");
    swal({
        title: '$disable_sm',
        text: '$disable_lg',
        // icon: "warning",
        imageUrl: '$AUTH_ASSETS' + 'img/order_confirm.png',
        imageWidth: 70,
        imageHeight: 70,
        allowOutsideClick: false,
        imageAlt: 'Custom image',
        animation: false,
        confirmButtonColor: '#AA4A44',
        cancelButtonColor: '#808080',
        confirmButtonText: "Yes",
        showCancelButton: true,
        // confirmButtonText: '$delete_btn_cfm',
        // cancelButtonText: '$confirm_cncl',
        // confirmButtonClass: 'btn btn-success me-2',
        // cancelButtonClass: 'btn btn-danger',
    }).then((result) => {
        if (result.value) {


            $.ajax({
                url: "$disable_category",
                type: 'post',
                dataType: 'Json',
                data: {
                    "{$this->security->get_csrf_token_name()}": "{$this->security->get_csrf_hash()}",
                    id: id
                },
                success: function(data) {
                    if(data.token){
                        $('input[name="{$this->security->get_csrf_token_name()}"]').val(data.token);
                    }
                    swal({
                        title: '$disable_succ_sm',
                        text: '$disable_succ_lg',
                        // icon: 'success',
                        imageUrl: '$AUTH_ASSETS' + 'img/order_confirms.png',
                        imageWidth: 70,
                        imageHeight: 70,
                        allowOutsideClick: false,
                        imageAlt: 'Custom image',
                    }).then((result) => {

                       location.reload();


                    });
                }
            })
        }
    })

});

$(document).on('click', '.enable_menu', function(e) {
    e.preventDefault();
    var id = $(this).attr("id");
    swal({
        title: '$enable_sm',
        text: '$enable_lg',
        // icon: "warning",
        imageUrl: '$AUTH_ASSETS' + 'img/order_confirm.png',
        imageWidth: 70,
        imageHeight: 70,
        allowOutsideClick: false,
        imageAlt: 'Custom image',
        animation: false,
        confirmButtonColor: '#AA4A44',
        cancelButtonColor: '#808080',
        confirmButtonText: "Yes",
        showCancelButton: true,
        // confirmButtonText: '$delete_btn_cfm',
        // cancelButtonText: '$confirm_cncl',
        // confirmButtonClass: 'btn btn-success me-2',
        // cancelButtonClass: 'btn btn-danger',
    }).then((result) => {
        if (result.value) {


            $.ajax({
                url: "$enable_category",
                type: 'post',
                dataType: 'Json',
                data: {
                    "{$this->security->get_csrf_token_name()}": "{$this->security->get_csrf_hash()}",
                    id: id
                },
                success: function(data) {
                    if(data.token){
                        $('input[name="{$this->security->get_csrf_token_name()}"]').val(data.token);
                    }
                    swal({
                        title: '$enable_succ_sm',
                        text: '$enable_succ_lg',
                        // icon: 'success',
                        imageUrl: '$AUTH_ASSETS' + 'img/order_confirms.png',
                        imageWidth: 70,
                        imageHeight: 70,
                        allowOutsideClick: false,
                        imageAlt: 'Custom image',
                    }).then((result) => {

                        location.reload();


                    });
                }
            })
        }
    })

});

$(document).on('click', '.view_data_chk', function(e) {
    e.preventDefault();
    var url = $(this).attr('href');
    const id = url.split('/').pop();
    $.ajax({
        url: url,
        type: "get",
        data: {
           "{$this->security->get_csrf_token_name()}": "{$this->security->get_csrf_hash()}",
           id :id

        },
        success: function(res) { 
            $('#edituserName').val(res.User.name);  // Set Category Name
            $('#editusermobile').val(res.user_query); 
            $('#edituserId').val(res.id);
            $('#statusDropdown2').val(res.status);
            $('#statusDropdown22').val(res.Query_status);  
            $("#modified_area_popup").modal({
                show: false,
                backdrop: 'static'
            });
            $('#modified_area_popup').modal('show');
            $('.body_data_chk').html(res.wrapper);
            //console.log(res);
        }
    });

});


$(document).on('click', '.view_buttonview_data_chk', function(e) {
    e.preventDefault();
    var url = $(this).attr('href');

    $.ajax({
        url: url,
        type: "post",
        data: {
           "{$this->security->get_csrf_token_name()}": "{$this->security->get_csrf_hash()}"
        },
        success: function(res) {
            $("#modified_area_popup").modal({
                show: false,
                backdrop: 'static'
            });
            $('#modified_area_popup').modal('show');
            $('.body_data_chk').html(res.wrapper);
            //console.log(res);
        }
    });
});


$(document).on('click', '#mobile-order-mgmt-tab', function(e) {
        e.preventDefault();
        $.ajax({
            url: "category/get_wall_menu_data",
            type: "post",
            data: {
               "menuFor": 1
            },
            success: function(resp) {
                $('.mobile_menu_order_data').html(resp);
                // / $('#feedback_modal').modal();
                position_load();
            }
        })
    })

 $(document).ready(function() {
        $('.dt-button').addClass('down_csv_btns');
        $('.dt-button').html('<i class="fa fa-download me-1" aria-hidden="true"></i>');
        // /$('#mobile-order-mgmt-tab').click();
         if($("#mobile-order-mgmt-tab").hasClass('active')) {
         //   alert('gfuyge')
            $('#mobile-order-mgmt-tab').click();
        }
        

    });
    let Status = $('#statusDropdown2').val(); // Set initial value
    // alert(Status);
    $(document).on('change', '#statusDropdown2', function () { 
    Status = $(this).val(); // Always keeps latest value
});

 let Q_Status = $('#statusDropdown22').val(); // Set initial value
    // alert(Status);
    $(document).on('change', '#statusDropdown2', function () { 
    Q_Status = $(this).val(); // Always keeps latest value
});

    // update data ajax
    $(document).on('submit', '#editCategoryForm', function (e) {
    e.preventDefault(); // Prevent default form submission

    const form = document.getElementById('editCategoryForm');
    const formData = new FormData(form); // Automatically collects all form inputs including fil
    var id = $('#edituserId').val();
    // const Status = $('#statusDropdown').val();  // Get selected value of status
     formData.append('Status', Status);
     formData.append('Q_Status',Q_Status);
    $.ajax({
        url: '/ticket/updateTicket'+ '/'+id, // Your controller endpoint
        type: 'post',
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
            alert('User updated successfully!');
            $('#modified_area_popup').modal('hide');
            // Optionally refresh table or update UI
        },
        error: function (xhr, status, error) {
            console.error('Error:', error);
            alert('Something went wrong while updating the user.');
        }
    });
});


</script>

